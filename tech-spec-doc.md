-- Membuat tipe data ENUM untuk peran (roles)
CREATE TYPE role_enum AS ENUM ('superadmin', 'admin', 'coach', 'client');

-- Tabel untuk menyimpan data profil dan role
CREATE TABLE profiles (
-- Wajib: foreign key ke auth.users.id
id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,

name TEXT NOT NULL,
phone_number TEXT,
email TEXT UNIQUE NOT NULL,
picture_url TEXT,

-- Menggunakan tipe ENUM yang sudah dibuat
role role_enum NOT NULL DEFAULT 'client',

created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Mengaktifkan RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Detail spesifik untuk Coach
CREATE TABLE coaches (
profile_id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
fixed_fee NUMERIC NOT NULL CHECK (fixed_fee >= 0), -- Harga sewa/hire Coach
is_active BOOLEAN DEFAULT TRUE
);

ALTER TABLE coaches ENABLE ROW LEVEL SECURITY;

-- Detail spesifik untuk Client (Opsional, tapi bisa digunakan untuk relasi)
CREATE TABLE clients (
profile_id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
notes TEXT
);

ALTER TABLE clients ENABLE ROW LEVEL SECURITY;

-- Tabel untuk data Lapangan
CREATE TABLE field_courts (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name TEXT NOT NULL,
fixed_price NUMERIC NOT NULL CHECK (fixed_price >= 0), -- Harga sewa Lapangan
address TEXT NOT NULL,
maps_url TEXT, -- URL atau embed link Google Maps
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE field_courts ENABLE ROW LEVEL SECURITY;

-- Tabel Booking
CREATE TABLE bookings (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

-- Relasi dengan Lapangan
court_id BIGINT NOT NULL REFERENCES field_courts(id),

-- Relasi dengan Coach dan Client
coach_id UUID REFERENCES profiles(id), -- Boleh NULL jika booking tanpa coach
client_id UUID NOT NULL REFERENCES profiles(id),

-- Detail Waktu dan Durasi
start_time TIMESTAMP WITH TIME ZONE NOT NULL,

-- Detail Harga (Penting untuk histori, jika harga di tabel sumber berubah)
final_court_price NUMERIC NOT NULL,
final_coach_fee NUMERIC NOT NULL,
total_price NUMERIC NOT NULL,

-- Detail Tambahan Booking
is_with_photography BOOLEAN DEFAULT FALSE,
adult_number INT NOT NULL DEFAULT 1 CHECK (adult_number >= 0),
children_number INT NOT NULL DEFAULT 0 CHECK (children_number >= 0),

status TEXT DEFAULT 'pending', -- (e.g., 'pending', 'confirmed', 'cancelled')
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Menambah constraint agar waktu booking tidak tumpang tindih (optional tapi disarankan)
-- Anda dapat mengimplementasikan ini menggunakan extension btree_gist dan exclusion constraint
-- Untuk saat ini, kita fokus pada schema dasar.

ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
